# YOLOベース椎体骨折検出システム開発計画書

## 📋 プロジェクト概要

### 目的
prior_YOLO_fileとSakaguchi_fileの実装を参考に、YOLOv8を使用した新しい椎体骨折検出システムを構築する。

### 目標
- 既存のResNet18分類モデルを上回る性能を達成
- より効率的で実用的な検出システムの構築
- 医療画像に特化したYOLOv8の最適化

### 開発期間
2025年7月16日 開始

## 🔍 既存システム分析結果

### Prior_YOLO_file（参考実装）
- **アーキテクチャ**: YOLOv3 + Keras
- **特徴**: 9方向スライス統合、複雑な後処理
- **課題**: 処理の複雑さ、計算コスト
- **活用点**: 多方向統合アイデア、アノテーション手法

### Sakaguchi_file（現行実装）
- **アーキテクチャ**: ResNet18 + PyTorch
- **特徴**: 医療画像特化処理、豊富な拡張
- **強み**: HUウィンドウ処理、効率的なパイプライン
- **活用点**: データ処理、前処理、拡張手法

## 🎯 新システム設計方針

### 1. 技術スタック
- **Deep Learning Framework**: PyTorch
- **YOLO実装**: Ultralytics YOLOv8
- **データ拡張**: Albumentations
- **実験管理**: Weights & Biases
- **画像処理**: OpenCV, scikit-image

### 2. データ処理戦略
- **入力**: Sakaguchi_fileの前処理済みデータを活用
- **断面**: 軸位スライス中心（後に冠状断面も検討）
- **解像度**: 640×640（YOLOv8推奨サイズ）
- **正規化**: 骨窓（100-2000 HU）→ 0-255スケール

### 3. アノテーション形式
```
# YOLOv8標準形式
class_id center_x center_y width height
0 0.5 0.4 0.2 0.3
```

### 4. モデル設定
- **モデルサイズ**: YOLOv8m（中サイズ、精度と速度のバランス）
- **クラス数**: 1クラス（骨折）
- **入力サイズ**: 640×640
- **事前学習**: COCO事前学習モデルを活用

## 📅 開発スケジュール

### フェーズ1: データ準備 (Week 1-2)
- [ ] **Task 5**: データ変換スクリプト実装
  - NIfTI → YOLO形式変換
  - バウンディングボックス生成
  - データセット分割
  - 品質チェック機能

### フェーズ2: モデル構築 (Week 3-4)
- [ ] **Task 6**: YOLOv8トレーニングシステム
  - 環境セットアップ
  - カスタムデータセット作成
  - 医療画像特化の前処理
  - 訓練パイプライン構築

### フェーズ3: 評価・検証 (Week 5-6)
- [ ] **Task 7**: 推論・評価システム
  - 推論スクリプト
  - 性能評価指標
  - 可視化機能
  - ResNet18との比較

### フェーズ4: 最適化・実験 (Week 7-8)
- [ ] **Task 8**: 実験・ベンチマーク
  - ハイパーパラメータ最適化
  - 各種手法比較
  - 最終評価

## 🔧 実装詳細

### データ処理パイプライン
```python
# メインの処理フロー
def process_medical_data():
    # 1. Sakaguchi_fileのデータ読み込み
    # 2. 椎体別スライス処理
    # 3. 骨折マスク → バウンディングボックス変換
    # 4. YOLO形式データセット作成
    # 5. 訓練/検証/テスト分割
```

### モデル訓練設定
```yaml
# 訓練設定例
model: yolov8m.pt
data: vertebrae_fracture.yaml
epochs: 100
imgsz: 640
batch: 16
lr0: 0.01
weight_decay: 0.0005
```

### 評価指標
- **検出精度**: mAP@0.5, mAP@0.5:0.95
- **医療指標**: 感度、特異度、AUC
- **効率性**: 推論速度、メモリ使用量
- **比較評価**: ResNet18との性能比較

## 📊 進捗管理

### 進捗状況
- [x] **2025-07-16**: プロジェクト開始、既存システム分析完了
- [x] **2025-07-16**: 設計方針決定、開発計画書作成
- [ ] **予定**: データ変換スクリプト実装開始
- [ ] **予定**: YOLOv8環境セットアップ
- [ ] **予定**: 初期モデル訓練

### マイルストーン
- **M1**: データ準備完了 (Week 2)
- **M2**: 初期モデル訓練完了 (Week 4)
- **M3**: 性能評価完了 (Week 6)
- **M4**: 最終システム完成 (Week 8)

## 🎯 成功基準

### 定量的指標
- **mAP@0.5**: > 0.7
- **感度**: > 0.85
- **特異度**: > 0.80
- **推論速度**: < 100ms/image

### 定性的指標
- ResNet18分類モデルとの性能比較
- 医療現場での実用性評価
- システムの拡張性・保守性

## 🚨 リスク管理

### 技術的リスク
- **データ不足**: 少数症例での過学習
- **アノテーション品質**: バウンディングボックスの精度
- **計算資源**: GPU メモリ不足

### 対策
- **データ拡張**: Albumentationsによる豊富な拡張
- **品質チェック**: 自動バリデーション機能
- **効率化**: Mixed Precision、Gradient Checkpointing

## 📝 参考資料

### 既存実装
- `prior_YOLO_file/`: YOLOv3実装、9方向統合手法
- `Sakaguchi_file/`: ResNet18実装、医療画像処理

### 技術文献
- YOLOv8: https://github.com/ultralytics/ultralytics
- 医療画像でのYOLO応用事例
- 椎体骨折検出の先行研究

---

## 📈 進捗ログ

### 2025-07-16
- **完了**: 既存システム分析（prior_YOLO_file, Sakaguchi_file）
- **完了**: 新システム設計方針決定
- **完了**: 開発計画書作成
- **完了**: axialスライス用YOLO形式変換スクリプト実装（`YOLO_data_conversion/nifti_to_yolo.py`）
- **完了**: YOLOv8訓練パイプライン実装（`YOLO_training/train_yolo.py`）
- **完了**: 推論・評価システム実装（`YOLO_inference/predict_yolo.py`）
- **完了**: 環境セットアップスクリプト実装（`YOLO_setup/setup_yolo.py`）
- **完了**: 完全パイプライン実行スクリプト実装（`run_yolo_pipeline.sh`）

### 2025-07-17
- **完了**: データ変換バグ修正（骨折画像のBBox生成問題を解決）
- **完了**: prior_YOLO_fileのBBox生成手法分析
  - 9方向統合アプローチの理解
  - マージン・パディング設定（MARGIN=10, SLB=15）
  - 小さな骨折領域統合手法の分析
- **完了**: バウンディングボックス生成アルゴリズム大幅改良
  - 複数骨折領域の統合（全領域を包含する単一BBox）
  - 適応的マージン追加（基本2%、小さな骨折+5px、大きな骨折+10%）
  - モルフォロジー処理によるノイズ除去
  - アスペクト比調整（極端な細長形状の回避）
  - 最小サイズ保証（画像の3%または10px）
  - 座標範囲検証とエラーハンドリング
- **完了**: 改良効果の確認
  - BBoxサイズ: 1.2% → 8-10%に大幅改善
  - 医療画像に適した適切なサイズ
  - YOLO学習に最適化されたBBox品質
- **完了**: バウンディングボックス可視化Notebook作成（`YOLO_visualization/bbox_visualization.ipynb`）
- **次回**: 改良されたYOLOデータセット作成・モデル訓練実行

### 今後の更新予定
各フェーズの完了時に詳細な進捗、課題、解決策を記録していく予定。

---

*このドキュメントは開発の進捗に応じて随時更新される*